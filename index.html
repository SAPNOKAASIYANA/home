<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gmail से साइन-इन और फोटो/वीडियो अपलोड</title>
<style>
body{font-family: Arial, Helvetica, sans-serif; max-width:1000px;margin:20px auto;padding:10px}
header{display:flex;align-items:center;justify-content:space-between}
.profile{display:flex;align-items:center;gap:10px}
img.avatar{width:48px;height:48px;border-radius:50%;object-fit:cover}
main{margin-top:20px}
.uploader{border:1px solid #ddd;padding:12px;border-radius:8px}
.posts{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.post{border:1px solid #ccc;padding:12px;border-radius:8px}
.post-media img,.post-media video{max-width:100%;height:auto;border-radius:6px}
.likes-comments{display:flex;gap:12px;align-items:center;margin-top:8px}
button{cursor:pointer}
.comments-list{margin-top:8px}
.comment{border-top:1px solid #eee;padding:6px 0}
</style>
</head>
<body>
<header>
<h2>सामाजिक वेब (डेमो)</h2>
<div class="profile">
<div id="user-area">
<button id="login-btn">Sign in with Google</button>
</div>
</div>
</header>


<main>
<section class="uploader" id="uploader" style="display:none">
<h3>अपना पोस्ट डालें</h3>
<div>
<label>फोटो/वीडियो चुनें: <input type="file" id="media-file" accept="image/*,video/*"></label>
</div>
<div style="margin-top:8px">
<input id="caption" placeholder="Caption लिखें (वैकल्पिक)" style="width:80%">
</div>
<div style="margin-top:8px">
<button id="upload-btn">Upload</button>
<button id="logout-btn">Logout</button>
</div>
<div id="upload-status" style="margin-top:8px;color:green"></div>
</section>


<section class="posts" id="posts"></section>
</main>
  <!-- Firebase v9 modular SDK (CDN) -->
<script type="module">
// **************** IMPORTANT ****************
// इस कोड को काम करने के लिए आपको Firebase console में project बनाना होगा,
// Authentication -> Sign-in method -> Google को enable करना होगा,
// Firestore Database और Storage बनाकर नीचे की CONFIG भरनी होगी.
// ************************************************


import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, onSnapshot, updateDoc, arrayUnion, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';


// --- अपना Firebase config यहाँ डालें ---
const firebaseConfig = {
apiKey: "REPLACE_API_KEY",
authDomain: "REPLACE_AUTH_DOMAIN",
projectId: "REPLACE_PROJECT_ID",
storageBucket: "REPLACE_STORAGE_BUCKET",
messagingSenderId: "REPLACE_MESSAGING_SENDER_ID",
appId: "REPLACE_APP_ID"
};


const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);
const storage = getStorage(app);


// UI
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userArea = document.getElementById('user-area');
const uploader = document.getElementById('uploader');
const uploadBtn = document.getElementById('upload-btn');
const mediaFile = document.getElementById('media-file');
const captionInput = document.getElementById('caption');
const uploadStatus = document.getElementById('upload-status');
const postsEl = document.getElementById('posts');


let currentUser = null;


// साइन-इन
loginBtn.addEventListener('click', async ()=>{
try{
await signInWithPopup(auth, provider);
}catch(e){
alert('Login failed: '+e.message);
}
});

  // साइन-आउट
logoutBtn.addEventListener('click', async ()=>{
await signOut(auth);
});


// ऑथ स्टेट बदलने पर UI अपडेट
onAuthStateChanged(auth, async (user)=>{
currentUser = user;
if(user){
// user object में displayName, photoURL, uid
userArea.innerHTML = `<img src="${user.photoURL}" class="avatar"> <strong>${user.displayName}</strong>`;
uploader.style.display = 'block';
}else{
userArea.innerHTML = `<button id="login-btn">Sign in with Google</button>`;
// reattach handler
document.getElementById('login-btn').addEventListener('click', async ()=>{ await signInWithPopup(auth, provider); });
uploader.style.display = 'none';
}
});


// Upload handler
uploadBtn.addEventListener('click', async ()=>{
if(!currentUser){ alert('कृपया पहले साइन-इन करें'); return; }
const file = mediaFile.files[0];
if(!file){ alert('फाइल चुनें'); return; }


const ext = file.name.split('.').pop();
const storagePath = `posts/${currentUser.uid}/${Date.now()}.${ext}`;
const storageRef = sRef(storage, storagePath);
const uploadTask = uploadBytesResumable(storageRef, file);


uploadStatus.textContent = 'Uploading...';


uploadTask.on('state_changed', (snapshot)=>{
// progress अगर दिखाना चाहें तो
}, (error)=>{
uploadStatus.textContent = 'Upload failed: '+error.message;
}, async ()=>{
const url = await getDownloadURL(uploadTask.snapshot.ref);
// Firestore में पोस्ट बनाएं
const post = {
uid: currentUser.uid,
name: currentUser.displayName || 'Unknown',
photoURL: currentUser.photoURL || null,
mediaURL: url,
mediaType: file.type.startsWith('video') ? 'video' : 'image',
caption: captionInput.value || '',
likes: [], // user uids
comments: [], // {uid, name, text, createdAt}
createdAt: serverTimestamp()
};
await addDoc(collection(db, 'posts'), post);
uploadStatus.textContent = 'Uploaded ✓';
mediaFile.value = '';
captionInput.value = '';
});
});

  // Real-time listener: सभी पोस्ट दिखाएँ (असली ऐप में pagination चाहिए)
const postsCol = collection(db, 'posts');
onSnapshot(postsCol, (snapshot)=>{
// आसान दिखाने के लिए newest first
const docs = [];
snapshot.forEach(d=>docs.push({id:d.id, ...d.data()}));
docs.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
renderPosts(docs);
});


function renderPosts(posts){
postsEl.innerHTML = '';
for(const p of posts){
const div = document.createElement('div');
div.className = 'post';
const ownerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${p.photoURL||''}" class="avatar"> <strong>${escapeHtml(p.name)}</strong></div>`;
const captionHTML = p.caption ? `<div style="margin-top:8px">${escapeHtml(p.caption)}</div>` : '';
const mediaHTML = p.mediaType === 'video' ? `<video controls src="${p.mediaURL}"></video>` : `<img src="${p.mediaURL}" alt="media">`;


// likes count and whether current user liked
const liked = currentUser && p.likes && p.likes.includes(currentUser.uid);
const likeText = `Like (${p.likes ? p.likes.length : 0})`;


div.innerHTML = `
${ownerHTML}
${captionHTML}
<div class="post-media" style="margin-top:8px">${mediaHTML}</div>
<div class="likes-comments">
<button data-action="like" data-id="${p.id}">${likeText}</button>
<button data-action="comment" data-id="${p.id}">Comment</button>
</div>
<div class="comments-list" id="comments-${p.id}">
</div>
`;
  // comments list
const commentsContainer = div.querySelector('#comments-'+p.id);
if(p.comments && p.comments.length){
p.comments.forEach(c=>{
const cdiv = document.createElement('div');
cdiv.className = 'comment';
const when = c.createdAt && c.createdAt.toDate ? c.createdAt.toDate().toLocaleString() : '';
cdiv.innerHTML = `<strong>${escapeHtml(c.name)}</strong> <div>${escapeHtml(c.text)}</div>`;
commentsContainer.appendChild(cdiv);
});
}


// event listeners
div.querySelectorAll('button').forEach(btn=>{
btn.addEventListener('click', async (ev)=>{
const action = btn.getAttribute('data-action');
const id = btn.getAttribute('data-id');
if(action === 'like'){
await toggleLike(id);
}else if(action === 'comment'){
const text = prompt('अपना कमेंट लिखें:');
if(text && text.trim()) await addComment(id, text.trim());
}
});
});


postsEl.appendChild(div);
}
}


async function toggleLike(postId){
if(!currentUser){ alert('कृपया साइन-इन करें'); return; }
const pDoc = doc(db, 'posts', postId);
// सरल तरीका: हम client-side current likes पढ़कर decide करें — नोट: race condition हो सकता है
const snap = await getDocs(collection(db, 'posts'));
// बेहतर: पढ़ो single doc — यहाँ सरल रखा गया
// अभी update करना: यदि user पहले से liked है तो remove वरना add
// We'll use update with arrayUnion/arrayRemove — but arrayRemove needs import; to keep simple we'll fetch doc then set updated array
const d = await (await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')).getDoc(pDoc);
const data = d.exists() ? d.data() : null;
if(!data) return;
const likes = data.likes || [];
const uid = currentUser.uid;
const already = likes.includes(uid);
const newLikes = already ? likes.filter(x=>x!==uid) : [...likes, uid];
await updateDoc(pDoc, { likes: newLikes });
}


async function addComment(postId, text){
if(!currentUser){ alert('कृपया साइन-इन करें'); return; }
const pDoc = doc(db, 'posts', postId);
const comment = { uid: currentUser.uid, name: currentUser.displayName, text, createdAt: serverTimestamp() };
await updateDoc(pDoc, { comments: arrayUnion(comment) });
}


// छोटा सा HTML एस्केप
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, (s)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }


</script>
</body>
</html>
